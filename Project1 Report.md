**Deliverable 1- ER Diagram**

![1573438083081](C:\Users\admin\AppData\Roaming\Typora\typora-user-images\1573438083081.png)





**##Deliverable 2 and 3-****
**##1. Create table, foreign keys, indexes, etc.**
**##2. Initial load and normalized tables should be present in your DB account**
**##3. SQL statements**

##### **##Create author table :-**

CREATE TABLE project1_Author (
Author_Id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
Author_Name VARCHAR2(50),
CONSTRAINT project1_Author_pk PRIMARY KEY (Author_Id)
);

**###insert different authors using regex to ',' and normalizing the load table**

insert into project1_Author (author_name) 
select distinct REGEXP_SUBSTR (authro, '[^,]+', 1, 1) from project1_books_load 
where REGEXP_SUBSTR (authro, '[^,]+', 1, 1) is not null

insert into project1_Author (author_name) 
select distinct REGEXP_SUBSTR (authro, '[^,]+', 1, 2) from project1_books_load 
where REGEXP_SUBSTR (authro, '[^,]+', 1, 2) is not null

insert into project1_Author (author_name) 
select distinct REGEXP_SUBSTR (authro, '[^,]+', 1, 3) from project1_books_load 
where REGEXP_SUBSTR (authro, '[^,]+', 1, 3) is not null

insert into project1_Author (author_name) 
select distinct REGEXP_SUBSTR (authro, '[^,]+', 1, 4) from project1_books_load 
where REGEXP_SUBSTR (authro, '[^,]+', 1, 4) is not null

insert into project1_Author (author_name) 
select distinct REGEXP_SUBSTR (authro, '[^,]+', 1, 5) from project1_books_load 
where REGEXP_SUBSTR (authro, '[^,]+', 1, 5) is not null

commit

##### ##Create books table:-

CREATE TABLE project1_books (
Book_title VARCHAR2(500),
ISBN13 Number(13) ,
pages number,
cover VARCHAR2(50),
publisher VARCHAR2(50),
CONSTRAINT project1_books_pk PRIMARY KEY (ISBN13)
);

**###insert books and ISBN13 of books to books table**

insert into project1_books(isbn13,book_title,pages,cover,publisher)
select isbn13,title,pages,cover,publisher from project1_books_load

commit

##### ##Create Books_Author table:-

CREATE TABLE project1_book_authors (
author_id Number(13) ,
ISBN13 Number(13) ,
CONSTRAINT project1_book_authors_pk PRIMARY KEY (author_id,ISBN13)
CONSTRAINT project1_book_authors_fk foreign KEY (author_id) references project1_Author
CONSTRAINT project1_book_authors_fk1 foreign KEY (ISBN13) references project1_books
);

**###Insert books as its ISBN13 with their respective authors as its authorID to Book_author table** 

insert into project1_book_authors
select author_id,isbn13 from ( select p2.author_id,p1.isbn13 from project1_books_load p1, project1_author p2
where
(p1.authro like '%' || p2.author_name ||  ',' || '%') or
(p1.authro like '%' || ',' ||  p2.author_name || '%') or
(p1.authro = p2.author_name)) order by author_id

##### ##Create Library_branch table

CREATE TABLE project1_library_branch (
branch_id NUMBER(5),
branch_name VARCHAR2(20) ,
address VARCHAR2(50),
CONSTRAINT project1_library_branch_pk PRIMARY KEY (branch_id)
);

**###Insert branch data into the table**

insert into project1_library_branch (address,branch_id,branch_name)
select address,branch_id,branch_name from project1_library_branch_load

commit

##### ###Create and inserting data for book_copies table On applying loop with IF condition on No_of_copies:-

CREATE SEQUENCE author_id_seq
  MINVALUE 1
  MAXVALUE 9999999
  START WITH 1
  INCREMENT BY 1
  Nocache;

CREATE TABLE project1_book_copies (
branch_id NUMBER(38,0),
book_id varchar2(20) ,
isbn varchar2(20),
no_of_copies number(2),
constraint pk_book_id primary key (book_id)
);
Begin
    for i in (select book_id,branch_id,no_of_copies from project1_book_copies_load)
        loop
        if i.no_of_copies =2 then 
            insert into project1_book_copies (book_id,isbn,branch_id,no_of_copies) values (author_id_seq.nextval, i.book_id,i.branch_id,i.no_of_copies);
            insert into project1_book_copies (book_id,isbn,branch_id,no_of_copies) values (author_id_seq.nextval, i.book_id,i.branch_id,i.no_of_copies);
            commit;
            else
            if i.no_of_copies =1 then 
            insert into project1_book_copies (book_id,isbn,branch_id,no_of_copies) values (author_id_seq.nextval, i.book_id,i.branch_id,i.no_of_copies);
            commit;
            end if;
            if i.no_of_copies =0 then
            insert into project1_book_copies (book_id,isbn,branch_id,no_of_copies) values (author_id_seq.nextval, i.book_id,i.branch_id,i.no_of_copies);
            commit;
            end if;
    End if;
    End loop;
End;
    

##### ##Create Borrowers table

CREATE TABLE project1_borrowers (
CardNo NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
SSN VARCHAR2(20) ,
Firstname VARCHAR2(50),
LastName VARCHAR2(50),
Address VARCHAR2(50),
City VARCHAR2(50),
State VARCHAR2(50),
Email VARCHAR2(50),
Phone VARCHAR2(20),
CONSTRAINT project1_borrowers_pk PRIMARY KEY (CardNo)
);

##### ###Insert Borrowers date with cardNo as primary key

insert into project1_borrowers (SSN,Firstname,LastName,Address,City,State,Email,Phone)
select SSN,First_name,Last_Name,Address,City,State,Email,Phone from project1_borrowers_load

##### ##Create Book_Loans table

CREATE TABLE project1_book_loans (
loan_id NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
book_id varchar2(20) ,
cardno NUMBER,
date_out date,
due_date date,
date_in date,
CONSTRAINT project1_book_loans_pk PRIMARY KEY (loan_id),
CONSTRAINT project1_book_loans_fk foreign KEY (book_id) references project1_book_copies,
CONSTRAINT project1_book_loans_fk1 foreign KEY (cardno) references project1_borrowers
);

#Created Borrowers temp table importing cardno from borrowers table

create table borrowers_save (
id number generated by default on null as identity,
cardno number);

insert into borrowers_save (cardno)
select cardno from project1_borrowers

#Created temp loans table importing 500 books from Books_copies table

create table loansreserve(
book_id number);

insert into loansreserve(book_id)
(select book_id from project1_book_copies where rownum<=500)

**##Insert values to Loan table**

**#####3. Write SQL to generate:****
**##1.At least 500 books check-outs for at least 200 different borrowers and 100 different**
**books-**** 

**#Inserted 200 books from loan temp table**

insert into project1_book_loans (book_id)
(select book_id from loansreserve where rownum<=200)

**#Inserted repeated 100 books from Loans table**

insert into project1_book_loans (book_id)
(select book_id from project1_book_loans where rownum<=100)

**#Repeated those 100 books again**

insert into project1_book_loans (book_id)
(select book_id from project1_book_loans where rownum<=100)

**#Inserted 100 books again from loan temp table**

insert into project1_book_loans (book_id)
(select book_id from loansreserve where rownum<=100)

**#Update cardno from borrowers temp table**
update project1_book_loans l
set l.cardno= (select cardno from borrowers_save s where l.loan_id=s.id)

**#Update Dates**
**#Update date_out as date on which book was issued** 
update project1_book_loans l
set l.date_out=sysdate-rownum

**#Update Due date as 10 days after Date_out**
update project1_book_loans l
set l.due_date= l.date_out + 10

**#Update Date_in as date on which borrower returned the book**
**#Manipulated data for Date_in on the basis of Loan_Id**
update project1_book_loans l
set l.date_in= l.date_out + 15 where loan_id>=0 and loan_id<200
update project1_book_loans l
set l.date_in= l.date_out + 12 where loan_id>=200 and loan_id<278
update project1_book_loans l
set l.date_in= l.date_out + 5 where loan_id>=278 and loan_id<378

Commit

##### Create Fines table
create table project1_fines(
loan_id NUMBER,
due_date date,
date_in date,
fine_amt Number,
Paid varchar2(10),
book_id varchar2(20)
);

**insert Data as loan IDs for people who returned their book after the due date with their Fine amount and Paid Status**

**#####2. At least 50 fines records for 20 different borrowers**

insert into project1_fines(loan_id,due_date,date_in,book_id)
select loan_id,due_date,date_in,book_id from project1_book_loans l where l.date_in is null or l.date_in>l.due_date

Update project1_fines a
set fine_amt=(select 5*(date_in-due_date) from project1_book_loans b where a.loan_id = b.loan_id and date_in>due_date and date_in is not null);

Update project1_fines a
set paid= case when fine_amt is null then 'no' else 'yes' end

commit

**####Book Search and Availability**

Select distinct a.isbn13, a.book_title, c.author_name,f.no_of_copies,e.branch_id 
from project1_books a left join project1_book_authors b 
on a.isbn13=b.isbn13 left join project1_author c 
on b.author_id=c.author_id left join project1_book_copies d 
on b.isbn13=d.isbn left join project1_library_branch e 
on d.branch_id=e.branch_id  left join project1_book_copies_load f 
on d.isbn=f.book_id
Where a.book_title like '%&&param24%' 
or a.book_title like '%&&param24' 
or a.book_title like '&&param24%' 
or a.isbn13 like '%&&param24%' or 
a.isbn13 like '&&param24%'or 
a.isbn13 like '%&&param24' or 
c.author_name like '%&&param24%' or 
c.author_name like '&&param24%' or 
c.author_name like '%&&param24';

**####Report to get Top 10 most popular books in the last month**

WITH top10 AS(  
SELECT distinct
    book_id,  
    Dense_RANK() OVER(
    ORDER BY book_id
    ) my_rank
FROM 
    project1_book_loans
)
SELECT * FROM top10
WHERE my_rank <= 10
order by my_rank;

**####Report to get Top 10 books that were checked in late**

WITH top10 AS(  
SELECT distinct
    book_id,
    Dense_RANK() OVER(
    ORDER BY (date_in-due_date)
    ) my_rank
FROM 
    project1_Fines
)
SELECT * FROM top10
WHERE my_rank <= 10

####################################################################################################################################################